var be=Object.create;var E=Object.defineProperty;var we=Object.getOwnPropertyDescriptor;var ge=Object.getOwnPropertyNames;var me=Object.getPrototypeOf,Oe=Object.prototype.hasOwnProperty;var A=(a,s)=>()=>(s||a((s={exports:{}}).exports,s),s.exports),je=(a,s)=>{for(var c in s)E(a,c,{get:s[c],enumerable:!0})},B=(a,s,c,e)=>{if(s&&typeof s=="object"||typeof s=="function")for(let t of ge(s))!Oe.call(a,t)&&t!==c&&E(a,t,{get:()=>s[t],enumerable:!(e=we(s,t))||e.enumerable});return a};var V=(a,s,c)=>(c=a!=null?be(me(a)):{},B(s||!a||!a.__esModule?E(c,"default",{value:a,enumerable:!0}):c,a)),Se=a=>B(E({},"__esModule",{value:!0}),a);var K=A(h=>{"use strict";var M=h&&h.__assign||function(){return M=Object.assign||function(a){for(var s,c=1,e=arguments.length;c<e;c++){s=arguments[c];for(var t in s)Object.prototype.hasOwnProperty.call(s,t)&&(a[t]=s[t])}return a},M.apply(this,arguments)},D=h&&h.__awaiter||function(a,s,c,e){function t(n){return n instanceof c?n:new c(function(r){r(n)})}return new(c||(c=Promise))(function(n,r){function i(l){try{u(e.next(l))}catch(d){r(d)}}function o(l){try{u(e.throw(l))}catch(d){r(d)}}function u(l){l.done?n(l.value):t(l.value).then(i,o)}u((e=e.apply(a,s||[])).next())})},F=h&&h.__generator||function(a,s){var c={label:0,sent:function(){if(n[0]&1)throw n[1];return n[1]},trys:[],ops:[]},e,t,n,r;return r={next:i(0),throw:i(1),return:i(2)},typeof Symbol=="function"&&(r[Symbol.iterator]=function(){return this}),r;function i(u){return function(l){return o([u,l])}}function o(u){if(e)throw new TypeError("Generator is already executing.");for(;r&&(r=0,u[0]&&(c=0)),c;)try{if(e=1,t&&(n=u[0]&2?t.return:u[0]?t.throw||((n=t.return)&&n.call(t),0):t.next)&&!(n=n.call(t,u[1])).done)return n;switch(t=0,n&&(u=[u[0]&2,n.value]),u[0]){case 0:case 1:n=u;break;case 4:return c.label++,{value:u[1],done:!1};case 5:c.label++,t=u[1],u=[0];continue;case 7:u=c.ops.pop(),c.trys.pop();continue;default:if(n=c.trys,!(n=n.length>0&&n[n.length-1])&&(u[0]===6||u[0]===2)){c=0;continue}if(u[0]===3&&(!n||u[1]>n[0]&&u[1]<n[3])){c.label=u[1];break}if(u[0]===6&&c.label<n[1]){c.label=n[1],n=u;break}if(n&&c.label<n[2]){c.label=n[2],c.ops.push(u);break}n[2]&&c.ops.pop(),c.trys.pop();continue}u=s.call(a,c)}catch(l){u=[6,l],t=0}finally{e=n=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}};h.__esModule=!0;h.getMiddlewareHandler=h.MiddlewareContext=void 0;var H=function(){function a(){var s=this.constructor;this.context={},Object.setPrototypeOf(this,s.prototype)}return a.prototype.set=function(s,c){this.context[s]=c},a.prototype.get=function(s){return this.context[s]},a}();h.MiddlewareContext=H;var Pe=function(a,s,c,e){return D(void 0,void 0,void 0,function(){var t;return F(this,function(n){switch(n.label){case 0:t=a(s,c,e),n.label=1;case 1:return typeof(t==null?void 0:t.then)!="function"?[3,3]:[4,t];case 2:return t=n.sent(),[3,1];case 3:return[2,t]}})})},Ie=function(a,s){return function(c,e,t){return D(void 0,void 0,void 0,function(){var n,r,i;return F(this,function(o){switch(o.label){case 0:return n=M(M({},c),{somodMiddlewareContext:new H}),r=s.length,i=function(){return D(void 0,void 0,void 0,function(){var u,l,d;return F(this,function(f){switch(f.label){case 0:return r>0?(u=s[--r],[4,u(i,n,e)]):[3,2];case 1:return l=f.sent(),[2,l];case 2:return[4,Pe(a,n,e,t)];case 3:return d=f.sent(),[2,d]}})})},[4,i()];case 1:return[2,o.sent()]}})})}};h.getMiddlewareHandler=Ie});var q=A(j=>{"use strict";var Ee=j&&j.__createBinding||(Object.create?function(a,s,c,e){e===void 0&&(e=c);var t=Object.getOwnPropertyDescriptor(s,c);(!t||("get"in t?!s.__esModule:t.writable||t.configurable))&&(t={enumerable:!0,get:function(){return s[c]}}),Object.defineProperty(a,e,t)}:function(a,s,c,e){e===void 0&&(e=c),a[e]=s[c]});j.__esModule=!0;j.getMiddlewareHandler=void 0;var Me=K();Ee(j,Me,"getMiddlewareHandler")});var _e=A((Le,N)=>{var L,U,z,J,W,Q,X,Y,Z,$,x,k,ee,T,R,te,ne,re,S,ae,ie,oe,ue,ce,se,le,fe,de,C;(function(a){var s=typeof global=="object"?global:typeof self=="object"?self:typeof this=="object"?this:{};typeof define=="function"&&define.amd?define("tslib",["exports"],function(e){a(c(s,c(e)))}):typeof N=="object"&&typeof N.exports=="object"?a(c(s,c(N.exports))):a(c(s));function c(e,t){return e!==s&&(typeof Object.create=="function"?Object.defineProperty(e,"__esModule",{value:!0}):e.__esModule=!0),function(n,r){return e[n]=t?t(n,r):r}}})(function(a){var s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])};L=function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");s(e,t);function n(){this.constructor=e}e.prototype=t===null?Object.create(t):(n.prototype=t.prototype,new n)},U=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},z=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]]);return n},J=function(e,t,n,r){var i=arguments.length,o=i<3?t:r===null?r=Object.getOwnPropertyDescriptor(t,n):r,u;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(e,t,n,r);else for(var l=e.length-1;l>=0;l--)(u=e[l])&&(o=(i<3?u(o):i>3?u(t,n,o):u(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},W=function(e,t){return function(n,r){t(n,r,e)}},Q=function(e,t,n,r,i,o){function u(P){if(P!==void 0&&typeof P!="function")throw new TypeError("Function expected");return P}for(var l=r.kind,d=l==="getter"?"get":l==="setter"?"set":"value",f=!t&&e?r.static?e:e.prototype:null,_=t||(f?Object.getOwnPropertyDescriptor(f,r.name):{}),y,v=!1,p=n.length-1;p>=0;p--){var b={};for(var w in r)b[w]=w==="access"?{}:r[w];for(var w in r.access)b.access[w]=r.access[w];b.addInitializer=function(P){if(v)throw new TypeError("Cannot add initializers after decoration has completed");o.push(u(P||null))};var g=(0,n[p])(l==="accessor"?{get:_.get,set:_.set}:_[d],b);if(l==="accessor"){if(g===void 0)continue;if(g===null||typeof g!="object")throw new TypeError("Object expected");(y=u(g.get))&&(_.get=y),(y=u(g.set))&&(_.set=y),(y=u(g.init))&&i.push(y)}else(y=u(g))&&(l==="field"?i.push(y):_[d]=y)}f&&Object.defineProperty(f,r.name,_),v=!0},X=function(e,t,n){for(var r=arguments.length>2,i=0;i<t.length;i++)n=r?t[i].call(e,n):t[i].call(e);return r?n:void 0},Y=function(e){return typeof e=="symbol"?e:"".concat(e)},Z=function(e,t,n){return typeof t=="symbol"&&(t=t.description?"[".concat(t.description,"]"):""),Object.defineProperty(e,"name",{configurable:!0,value:n?"".concat(n," ",t):t})},$=function(e,t){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(e,t)},x=function(e,t,n,r){function i(o){return o instanceof n?o:new n(function(u){u(o)})}return new(n||(n=Promise))(function(o,u){function l(_){try{f(r.next(_))}catch(y){u(y)}}function d(_){try{f(r.throw(_))}catch(y){u(y)}}function f(_){_.done?o(_.value):i(_.value).then(l,d)}f((r=r.apply(e,t||[])).next())})},k=function(e,t){var n={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},r,i,o,u;return u={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(u[Symbol.iterator]=function(){return this}),u;function l(f){return function(_){return d([f,_])}}function d(f){if(r)throw new TypeError("Generator is already executing.");for(;u&&(u=0,f[0]&&(n=0)),n;)try{if(r=1,i&&(o=f[0]&2?i.return:f[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,f[1])).done)return o;switch(i=0,o&&(f=[f[0]&2,o.value]),f[0]){case 0:case 1:o=f;break;case 4:return n.label++,{value:f[1],done:!1};case 5:n.label++,i=f[1],f=[0];continue;case 7:f=n.ops.pop(),n.trys.pop();continue;default:if(o=n.trys,!(o=o.length>0&&o[o.length-1])&&(f[0]===6||f[0]===2)){n=0;continue}if(f[0]===3&&(!o||f[1]>o[0]&&f[1]<o[3])){n.label=f[1];break}if(f[0]===6&&n.label<o[1]){n.label=o[1],o=f;break}if(o&&n.label<o[2]){n.label=o[2],n.ops.push(f);break}o[2]&&n.ops.pop(),n.trys.pop();continue}f=t.call(e,n)}catch(_){f=[6,_],i=0}finally{r=o=0}if(f[0]&5)throw f[1];return{value:f[0]?f[1]:void 0,done:!0}}},ee=function(e,t){for(var n in e)n!=="default"&&!Object.prototype.hasOwnProperty.call(t,n)&&C(t,e,n)},C=Object.create?function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||("get"in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]},T=function(e){var t=typeof Symbol=="function"&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},R=function(e,t){var n=typeof Symbol=="function"&&e[Symbol.iterator];if(!n)return e;var r=n.call(e),i,o=[],u;try{for(;(t===void 0||t-- >0)&&!(i=r.next()).done;)o.push(i.value)}catch(l){u={error:l}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(u)throw u.error}}return o},te=function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(R(arguments[t]));return e},ne=function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;for(var r=Array(e),i=0,t=0;t<n;t++)for(var o=arguments[t],u=0,l=o.length;u<l;u++,i++)r[i]=o[u];return r},re=function(e,t,n){if(n||arguments.length===2)for(var r=0,i=t.length,o;r<i;r++)(o||!(r in t))&&(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))},S=function(e){return this instanceof S?(this.v=e,this):new S(e)},ae=function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=n.apply(e,t||[]),i,o=[];return i={},u("next"),u("throw"),u("return"),i[Symbol.asyncIterator]=function(){return this},i;function u(v){r[v]&&(i[v]=function(p){return new Promise(function(b,w){o.push([v,p,b,w])>1||l(v,p)})})}function l(v,p){try{d(r[v](p))}catch(b){y(o[0][3],b)}}function d(v){v.value instanceof S?Promise.resolve(v.value.v).then(f,_):y(o[0][2],v)}function f(v){l("next",v)}function _(v){l("throw",v)}function y(v,p){v(p),o.shift(),o.length&&l(o[0][0],o[0][1])}},ie=function(e){var t,n;return t={},r("next"),r("throw",function(i){throw i}),r("return"),t[Symbol.iterator]=function(){return this},t;function r(i,o){t[i]=e[i]?function(u){return(n=!n)?{value:S(e[i](u)),done:!1}:o?o(u):u}:o}},oe=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],n;return t?t.call(e):(e=typeof T=="function"?T(e):e[Symbol.iterator](),n={},r("next"),r("throw"),r("return"),n[Symbol.asyncIterator]=function(){return this},n);function r(o){n[o]=e[o]&&function(u){return new Promise(function(l,d){u=e[o](u),i(l,d,u.done,u.value)})}}function i(o,u,l,d){Promise.resolve(d).then(function(f){o({value:f,done:l})},u)}},ue=function(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e};var c=Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t};ce=function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n in e)n!=="default"&&Object.prototype.hasOwnProperty.call(e,n)&&C(t,e,n);return c(t,e),t},se=function(e){return e&&e.__esModule?e:{default:e}},le=function(e,t,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(e):r?r.value:t.get(e)},fe=function(e,t,n,r,i){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?i.call(e,n):i?i.value=n:t.set(e,n),n},de=function(e,t){if(t===null||typeof t!="object"&&typeof t!="function")throw new TypeError("Cannot use 'in' operator on non-object");return typeof e=="function"?t===e:e.has(t)},a("__extends",L),a("__assign",U),a("__rest",z),a("__decorate",J),a("__param",W),a("__esDecorate",Q),a("__runInitializers",X),a("__propKey",Y),a("__setFunctionName",Z),a("__metadata",$),a("__awaiter",x),a("__generator",k),a("__exportStar",ee),a("__createBinding",C),a("__values",T),a("__read",R),a("__spread",te),a("__spreadArrays",ne),a("__spreadArray",re),a("__await",S),a("__asyncGenerator",ae),a("__asyncDelegator",ie),a("__asyncValues",oe),a("__makeTemplateObject",ue),a("__importStar",ce),a("__importDefault",se),a("__classPrivateFieldGet",le),a("__classPrivateFieldSet",fe),a("__classPrivateFieldIn",de)})});var Ve={};je(Ve,{default:()=>Be});module.exports=Se(Ve);var pe=V(q());var ve=V(_e(),1),{__extends:Ue,__assign:ze,__rest:Je,__decorate:We,__param:Qe,__esDecorate:Xe,__runInitializers:Ye,__propKey:Ze,__setFunctionName:$e,__metadata:xe,__awaiter:m,__generator:O,__exportStar:ke,__createBinding:et,__values:tt,__read:nt,__spread:rt,__spreadArrays:at,__spreadArray:it,__await:ot,__asyncGenerator:ut,__asyncDelegator:ct,__asyncValues:st,__makeTemplateObject:lt,__importStar:ft,__importDefault:dt,__classPrivateFieldGet:_t,__classPrivateFieldSet:vt,__classPrivateFieldIn:yt}=ve.default;var I=require("aws-sdk"),ye=new I.DynamoDB.DocumentClient({apiVersion:"2012-08-10",region:process.env.AWS_REGION}),G={},Te=function(a){return G[a]===void 0&&(G[a]=new I.ApiGatewayManagementApi({apiVersion:"2018-11-29",endpoint:a})),G[a]},Ce=function(a){return m(void 0,void 0,void 0,function(){var s,c;return O(this,function(e){switch(e.label){case 0:return[4,ye.query({TableName:process.env.USERS_TABLE_NAME,IndexName:"byGroupId",KeyConditionExpression:"groupId = :groupId",ExpressionAttributeValues:{":groupId":a}}).promise()];case 1:return s=e.sent(),[2,(c=s.Items||[])===null||c===void 0?void 0:c.map(function(t){return t.id})]}})})},Ne=function(){return m(void 0,void 0,void 0,function(){var a,s;return O(this,function(c){switch(c.label){case 0:return[4,ye.scan({TableName:process.env.CONNECTIONS_TABLE_NAME}).promise()];case 1:return a=c.sent(),[2,(s=a.Items||[])===null||s===void 0?void 0:s.map(function(e){return{connectionId:e.connectionId,userId:e.userId}})]}})})},Ae=function(a,s){var c=Object.fromEntries(s.map(function(e){return[e,!0]}));return a.filter(function(e){return c[e.userId]})},De=function(a,s){return m(void 0,void 0,void 0,function(){var c,e;return O(this,function(t){switch(t.label){case 0:return c=Te(process.env.CONNECTIONS_ENDPOINT),e=typeof s=="string"?s:JSON.stringify(s),[4,c.postToConnection({ConnectionId:a,Data:e}).promise()];case 1:return t.sent(),[2]}})})},Fe=function(a){return m(void 0,void 0,void 0,function(){var s,c,e,t,n,r,i,o,u;return O(this,function(l){switch(l.label){case 0:return s=I.DynamoDB.Converter.unmarshall(((u=a.dynamodb)===null||u===void 0?void 0:u.NewImage)||{}),c=[],s.audience.userId?(c.push(s.audience.userId),[3,3]):[3,1];case 1:return s.audience.groupId?(t=(e=c.push).apply,n=[c],[4,Ce(s.audience.groupId)]):[3,3];case 2:t.apply(e,n.concat([l.sent()])),l.label=3;case 3:return[4,Ne()];case 4:return r=l.sent(),i=Ae(r,c),[4,Promise.allSettled(i.map(function(d){return m(void 0,void 0,void 0,function(){return O(this,function(f){switch(f.label){case 0:return[4,De(d.connectionId,s.message)];case 1:return f.sent(),[2]}})})}))];case 5:return o=l.sent(),console.log(JSON.stringify({messageId:s.messageId,audience:s.audience,noOfEligibleUsers:c.length,noOfEligibleConnections:i.length,noOfFailedConnections:o.filter(function(d){return d.status=="rejected"}).length})),[2]}})})},Re=function(a){return m(void 0,void 0,void 0,function(){var s,c,e;return O(this,function(t){switch(t.label){case 0:s=0,c=a.Records,t.label=1;case 1:return s<c.length?(e=c[s],e.eventName!="INSERT"?[3,3]:[4,Fe(e)]):[3,4];case 2:t.sent(),t.label=3;case 3:return s++,[3,1];case 4:return[2]}})})},he=Re;var Ge=(0,pe.getMiddlewareHandler)(he,[]),Be=Ge;0&&(module.exports={});
