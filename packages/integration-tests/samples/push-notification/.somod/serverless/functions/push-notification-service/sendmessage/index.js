var me=Object.create;var T=Object.defineProperty;var Oe=Object.getOwnPropertyDescriptor;var je=Object.getOwnPropertyNames;var Se=Object.getPrototypeOf,Ee=Object.prototype.hasOwnProperty;var N=(i,c)=>()=>(c||i((c={exports:{}}).exports,c),c.exports),Pe=(i,c)=>{for(var u in c)T(i,u,{get:c[u],enumerable:!0})},V=(i,c,u,l)=>{if(c&&typeof c=="object"||typeof c=="function")for(let e of je(c))!Ee.call(i,e)&&e!==u&&T(i,e,{get:()=>c[e],enumerable:!(l=Oe(c,e))||l.enumerable});return i};var H=(i,c,u)=>(u=i!=null?me(Se(i)):{},V(c||!i||!i.__esModule?T(u,"default",{value:i,enumerable:!0}):u,i)),Ie=i=>V(T({},"__esModule",{value:!0}),i);var q=N(h=>{"use strict";var M=h&&h.__assign||function(){return M=Object.assign||function(i){for(var c,u=1,l=arguments.length;u<l;u++){c=arguments[u];for(var e in c)Object.prototype.hasOwnProperty.call(c,e)&&(i[e]=c[e])}return i},M.apply(this,arguments)},R=h&&h.__awaiter||function(i,c,u,l){function e(t){return t instanceof u?t:new u(function(n){n(t)})}return new(u||(u=Promise))(function(t,n){function r(s){try{a(l.next(s))}catch(d){n(d)}}function o(s){try{a(l.throw(s))}catch(d){n(d)}}function a(s){s.done?t(s.value):e(s.value).then(r,o)}a((l=l.apply(i,c||[])).next())})},F=h&&h.__generator||function(i,c){var u={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},l,e,t,n;return n={next:r(0),throw:r(1),return:r(2)},typeof Symbol=="function"&&(n[Symbol.iterator]=function(){return this}),n;function r(a){return function(s){return o([a,s])}}function o(a){if(l)throw new TypeError("Generator is already executing.");for(;n&&(n=0,a[0]&&(u=0)),u;)try{if(l=1,e&&(t=a[0]&2?e.return:a[0]?e.throw||((t=e.return)&&t.call(e),0):e.next)&&!(t=t.call(e,a[1])).done)return t;switch(e=0,t&&(a=[a[0]&2,t.value]),a[0]){case 0:case 1:t=a;break;case 4:return u.label++,{value:a[1],done:!1};case 5:u.label++,e=a[1],a=[0];continue;case 7:a=u.ops.pop(),u.trys.pop();continue;default:if(t=u.trys,!(t=t.length>0&&t[t.length-1])&&(a[0]===6||a[0]===2)){u=0;continue}if(a[0]===3&&(!t||a[1]>t[0]&&a[1]<t[3])){u.label=a[1];break}if(a[0]===6&&u.label<t[1]){u.label=t[1],t=a;break}if(t&&u.label<t[2]){u.label=t[2],u.ops.push(a);break}t[2]&&u.ops.pop(),u.trys.pop();continue}a=c.call(i,u)}catch(s){a=[6,s],e=0}finally{l=t=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}};h.__esModule=!0;h.getMiddlewareHandler=h.MiddlewareContext=void 0;var K=function(){function i(){var c=this.constructor;this.context={},Object.setPrototypeOf(this,c.prototype)}return i.prototype.set=function(c,u){this.context[c]=u},i.prototype.get=function(c){return this.context[c]},i}();h.MiddlewareContext=K;var Te=function(i,c,u,l){return R(void 0,void 0,void 0,function(){var e;return F(this,function(t){switch(t.label){case 0:e=i(c,u,l),t.label=1;case 1:return typeof e?.then!="function"?[3,3]:[4,e];case 2:return e=t.sent(),[3,1];case 3:return[2,e]}})})},Me=function(i,c){return function(u,l,e){return R(void 0,void 0,void 0,function(){var t,n,r;return F(this,function(o){switch(o.label){case 0:return t=M(M({},u),{somodMiddlewareContext:new K}),n=c.length,r=function(){return R(void 0,void 0,void 0,function(){var a,s,d;return F(this,function(y){switch(y.label){case 0:return n>0?(a=c[--n],[4,a(r,t,l)]):[3,2];case 1:return s=y.sent(),[2,s];case 2:return[4,Te(i,t,l,e)];case 3:return d=y.sent(),[2,d]}})})},[4,r()];case 1:return[2,o.sent()]}})})}};h.getMiddlewareHandler=Me});var L=N(S=>{"use strict";var Ce=S&&S.__createBinding||(Object.create?function(i,c,u,l){l===void 0&&(l=u);var e=Object.getOwnPropertyDescriptor(c,u);(!e||("get"in e?!c.__esModule:e.writable||e.configurable))&&(e={enumerable:!0,get:function(){return c[u]}}),Object.defineProperty(i,l,e)}:function(i,c,u,l){l===void 0&&(l=u),i[l]=c[u]});S.__esModule=!0;S.getMiddlewareHandler=void 0;var De=q();Ce(S,De,"getMiddlewareHandler")});var ve=N((Je,A)=>{var U,z,J,W,Q,X,Y,Z,$,x,k,ee,te,C,G,ne,re,ae,E,ie,oe,ue,ce,se,le,fe,de,_e,D,ye,pe;(function(i){var c=typeof global=="object"?global:typeof self=="object"?self:typeof this=="object"?this:{};typeof define=="function"&&define.amd?define("tslib",["exports"],function(l){i(u(c,u(l)))}):typeof A=="object"&&typeof A.exports=="object"?i(u(c,u(A.exports))):i(u(c));function u(l,e){return l!==c&&(typeof Object.create=="function"?Object.defineProperty(l,"__esModule",{value:!0}):l.__esModule=!0),function(t,n){return l[t]=e?e(t,n):n}}})(function(i){var c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])};U=function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");c(e,t);function n(){this.constructor=e}e.prototype=t===null?Object.create(t):(n.prototype=t.prototype,new n)},z=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},J=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var o=0,r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]]);return n},W=function(e,t,n,r){var o=arguments.length,a=o<3?t:r===null?r=Object.getOwnPropertyDescriptor(t,n):r,s;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")a=Reflect.decorate(e,t,n,r);else for(var d=e.length-1;d>=0;d--)(s=e[d])&&(a=(o<3?s(a):o>3?s(t,n,a):s(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a},Q=function(e,t){return function(n,r){t(n,r,e)}},X=function(e,t,n,r,o,a){function s(P){if(P!==void 0&&typeof P!="function")throw new TypeError("Function expected");return P}for(var d=r.kind,y=d==="getter"?"get":d==="setter"?"set":"value",f=!t&&e?r.static?e:e.prototype:null,_=t||(f?Object.getOwnPropertyDescriptor(f,r.name):{}),v,p=!1,b=n.length-1;b>=0;b--){var w={};for(var g in r)w[g]=g==="access"?{}:r[g];for(var g in r.access)w.access[g]=r.access[g];w.addInitializer=function(P){if(p)throw new TypeError("Cannot add initializers after decoration has completed");a.push(s(P||null))};var m=(0,n[b])(d==="accessor"?{get:_.get,set:_.set}:_[y],w);if(d==="accessor"){if(m===void 0)continue;if(m===null||typeof m!="object")throw new TypeError("Object expected");(v=s(m.get))&&(_.get=v),(v=s(m.set))&&(_.set=v),(v=s(m.init))&&o.unshift(v)}else(v=s(m))&&(d==="field"?o.unshift(v):_[y]=v)}f&&Object.defineProperty(f,r.name,_),p=!0},Y=function(e,t,n){for(var r=arguments.length>2,o=0;o<t.length;o++)n=r?t[o].call(e,n):t[o].call(e);return r?n:void 0},Z=function(e){return typeof e=="symbol"?e:"".concat(e)},$=function(e,t,n){return typeof t=="symbol"&&(t=t.description?"[".concat(t.description,"]"):""),Object.defineProperty(e,"name",{configurable:!0,value:n?"".concat(n," ",t):t})},x=function(e,t){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(e,t)},k=function(e,t,n,r){function o(a){return a instanceof n?a:new n(function(s){s(a)})}return new(n||(n=Promise))(function(a,s){function d(_){try{f(r.next(_))}catch(v){s(v)}}function y(_){try{f(r.throw(_))}catch(v){s(v)}}function f(_){_.done?a(_.value):o(_.value).then(d,y)}f((r=r.apply(e,t||[])).next())})},ee=function(e,t){var n={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},r,o,a,s;return s={next:d(0),throw:d(1),return:d(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function d(f){return function(_){return y([f,_])}}function y(f){if(r)throw new TypeError("Generator is already executing.");for(;s&&(s=0,f[0]&&(n=0)),n;)try{if(r=1,o&&(a=f[0]&2?o.return:f[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,f[1])).done)return a;switch(o=0,a&&(f=[f[0]&2,a.value]),f[0]){case 0:case 1:a=f;break;case 4:return n.label++,{value:f[1],done:!1};case 5:n.label++,o=f[1],f=[0];continue;case 7:f=n.ops.pop(),n.trys.pop();continue;default:if(a=n.trys,!(a=a.length>0&&a[a.length-1])&&(f[0]===6||f[0]===2)){n=0;continue}if(f[0]===3&&(!a||f[1]>a[0]&&f[1]<a[3])){n.label=f[1];break}if(f[0]===6&&n.label<a[1]){n.label=a[1],a=f;break}if(a&&n.label<a[2]){n.label=a[2],n.ops.push(f);break}a[2]&&n.ops.pop(),n.trys.pop();continue}f=t.call(e,n)}catch(_){f=[6,_],o=0}finally{r=a=0}if(f[0]&5)throw f[1];return{value:f[0]?f[1]:void 0,done:!0}}},te=function(e,t){for(var n in e)n!=="default"&&!Object.prototype.hasOwnProperty.call(t,n)&&D(t,e,n)},D=Object.create?function(e,t,n,r){r===void 0&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);(!o||("get"in o?!t.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]},C=function(e){var t=typeof Symbol=="function"&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},G=function(e,t){var n=typeof Symbol=="function"&&e[Symbol.iterator];if(!n)return e;var r=n.call(e),o,a=[],s;try{for(;(t===void 0||t-- >0)&&!(o=r.next()).done;)a.push(o.value)}catch(d){s={error:d}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(s)throw s.error}}return a},ne=function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(G(arguments[t]));return e},re=function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;for(var r=Array(e),o=0,t=0;t<n;t++)for(var a=arguments[t],s=0,d=a.length;s<d;s++,o++)r[o]=a[s];return r},ae=function(e,t,n){if(n||arguments.length===2)for(var r=0,o=t.length,a;r<o;r++)(a||!(r in t))&&(a||(a=Array.prototype.slice.call(t,0,r)),a[r]=t[r]);return e.concat(a||Array.prototype.slice.call(t))},E=function(e){return this instanceof E?(this.v=e,this):new E(e)},ie=function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=n.apply(e,t||[]),o,a=[];return o={},s("next"),s("throw"),s("return"),o[Symbol.asyncIterator]=function(){return this},o;function s(p){r[p]&&(o[p]=function(b){return new Promise(function(w,g){a.push([p,b,w,g])>1||d(p,b)})})}function d(p,b){try{y(r[p](b))}catch(w){v(a[0][3],w)}}function y(p){p.value instanceof E?Promise.resolve(p.value.v).then(f,_):v(a[0][2],p)}function f(p){d("next",p)}function _(p){d("throw",p)}function v(p,b){p(b),a.shift(),a.length&&d(a[0][0],a[0][1])}},oe=function(e){var t,n;return t={},r("next"),r("throw",function(o){throw o}),r("return"),t[Symbol.iterator]=function(){return this},t;function r(o,a){t[o]=e[o]?function(s){return(n=!n)?{value:E(e[o](s)),done:!1}:a?a(s):s}:a}},ue=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],n;return t?t.call(e):(e=typeof C=="function"?C(e):e[Symbol.iterator](),n={},r("next"),r("throw"),r("return"),n[Symbol.asyncIterator]=function(){return this},n);function r(a){n[a]=e[a]&&function(s){return new Promise(function(d,y){s=e[a](s),o(d,y,s.done,s.value)})}}function o(a,s,d,y){Promise.resolve(y).then(function(f){a({value:f,done:d})},s)}},ce=function(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e};var u=Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t};se=function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n in e)n!=="default"&&Object.prototype.hasOwnProperty.call(e,n)&&D(t,e,n);return u(t,e),t},le=function(e){return e&&e.__esModule?e:{default:e}},fe=function(e,t,n,r){if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?r:n==="a"?r.call(e):r?r.value:t.get(e)},de=function(e,t,n,r,o){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!o)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?o.call(e,n):o?o.value=n:t.set(e,n),n},_e=function(e,t){if(t===null||typeof t!="object"&&typeof t!="function")throw new TypeError("Cannot use 'in' operator on non-object");return typeof e=="function"?t===e:e.has(t)},ye=function(e,t,n){if(t!=null){if(typeof t!="object"&&typeof t!="function")throw new TypeError("Object expected.");var r;if(n){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");r=t[Symbol.asyncDispose]}if(r===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");r=t[Symbol.dispose]}if(typeof r!="function")throw new TypeError("Object not disposable.");e.stack.push({value:t,dispose:r,async:n})}else n&&e.stack.push({async:!0});return t};var l=typeof SuppressedError=="function"?SuppressedError:function(e,t,n){var r=new Error(n);return r.name="SuppressedError",r.error=e,r.suppressed=t,r};pe=function(e){function t(r){e.error=e.hasError?new l(r,e.error,"An error was suppressed during disposal."):r,e.hasError=!0}function n(){for(;e.stack.length;){var r=e.stack.pop();try{var o=r.dispose&&r.dispose.call(r.value);if(r.async)return Promise.resolve(o).then(n,function(a){return t(a),n()})}catch(a){t(a)}}if(e.hasError)throw e.error}return n()},i("__extends",U),i("__assign",z),i("__rest",J),i("__decorate",W),i("__param",Q),i("__esDecorate",X),i("__runInitializers",Y),i("__propKey",Z),i("__setFunctionName",$),i("__metadata",x),i("__awaiter",k),i("__generator",ee),i("__exportStar",te),i("__createBinding",D),i("__values",C),i("__read",G),i("__spread",ne),i("__spreadArrays",re),i("__spreadArray",ae),i("__await",E),i("__asyncGenerator",ie),i("__asyncDelegator",oe),i("__asyncValues",ue),i("__makeTemplateObject",ce),i("__importStar",se),i("__importDefault",le),i("__classPrivateFieldGet",fe),i("__classPrivateFieldSet",de),i("__classPrivateFieldIn",_e),i("__addDisposableResource",ye),i("__disposeResources",pe)})});var qe={};Pe(qe,{default:()=>Ke});module.exports=Ie(qe);var ge=H(L());var he=H(ve(),1),{__extends:We,__assign:Qe,__rest:Xe,__decorate:Ye,__param:Ze,__esDecorate:$e,__runInitializers:xe,__propKey:ke,__setFunctionName:et,__metadata:tt,__awaiter:O,__generator:j,__exportStar:nt,__createBinding:rt,__values:at,__read:it,__spread:ot,__spreadArrays:ut,__spreadArray:ct,__await:st,__asyncGenerator:lt,__asyncDelegator:ft,__asyncValues:dt,__makeTemplateObject:_t,__importStar:yt,__importDefault:pt,__classPrivateFieldGet:vt,__classPrivateFieldSet:ht,__classPrivateFieldIn:bt,__addDisposableResource:wt,__disposeResources:gt}=he.default;var I=require("aws-sdk"),be=new I.DynamoDB.DocumentClient({apiVersion:"2012-08-10",region:process.env.AWS_REGION}),B={},Ae=function(i){return B[i]===void 0&&(B[i]=new I.ApiGatewayManagementApi({apiVersion:"2018-11-29",endpoint:i})),B[i]},Ne=function(i){return O(void 0,void 0,void 0,function(){var c,u;return j(this,function(l){switch(l.label){case 0:return[4,be.query({TableName:process.env.USERS_TABLE_NAME,IndexName:"byGroupId",KeyConditionExpression:"groupId = :groupId",ExpressionAttributeValues:{":groupId":i}}).promise()];case 1:return c=l.sent(),[2,(u=c.Items||[])===null||u===void 0?void 0:u.map(function(e){return e.id})]}})})},Re=function(){return O(void 0,void 0,void 0,function(){var i,c;return j(this,function(u){switch(u.label){case 0:return[4,be.scan({TableName:process.env.CONNECTIONS_TABLE_NAME}).promise()];case 1:return i=u.sent(),[2,(c=i.Items||[])===null||c===void 0?void 0:c.map(function(l){return{connectionId:l.connectionId,userId:l.userId}})]}})})},Fe=function(i,c){var u=Object.fromEntries(c.map(function(l){return[l,!0]}));return i.filter(function(l){return u[l.userId]})},Ge=function(i,c){return O(void 0,void 0,void 0,function(){var u,l;return j(this,function(e){switch(e.label){case 0:return u=Ae(process.env.CONNECTIONS_ENDPOINT),l=typeof c=="string"?c:JSON.stringify(c),[4,u.postToConnection({ConnectionId:i,Data:l}).promise()];case 1:return e.sent(),[2]}})})},Be=function(i){return O(void 0,void 0,void 0,function(){var c,u,l,e,t,n,r,o,a;return j(this,function(s){switch(s.label){case 0:return c=I.DynamoDB.Converter.unmarshall(((a=i.dynamodb)===null||a===void 0?void 0:a.NewImage)||{}),u=[],c.audience.userId?(u.push(c.audience.userId),[3,3]):[3,1];case 1:return c.audience.groupId?(e=(l=u.push).apply,t=[u],[4,Ne(c.audience.groupId)]):[3,3];case 2:e.apply(l,t.concat([s.sent()])),s.label=3;case 3:return[4,Re()];case 4:return n=s.sent(),r=Fe(n,u),[4,Promise.allSettled(r.map(function(d){return O(void 0,void 0,void 0,function(){return j(this,function(y){switch(y.label){case 0:return[4,Ge(d.connectionId,c.message)];case 1:return y.sent(),[2]}})})}))];case 5:return o=s.sent(),console.log(JSON.stringify({messageId:c.messageId,audience:c.audience,noOfEligibleUsers:u.length,noOfEligibleConnections:r.length,noOfFailedConnections:o.filter(function(d){return d.status=="rejected"}).length})),[2]}})})},Ve=function(i){return O(void 0,void 0,void 0,function(){var c,u,l;return j(this,function(e){switch(e.label){case 0:c=0,u=i.Records,e.label=1;case 1:return c<u.length?(l=u[c],l.eventName!="INSERT"?[3,3]:[4,Be(l)]):[3,4];case 2:e.sent(),e.label=3;case 3:return c++,[3,1];case 4:return[2]}})})},we=Ve;var He=(0,ge.getMiddlewareHandler)(we,[]),Ke=He;0&&(module.exports={});
